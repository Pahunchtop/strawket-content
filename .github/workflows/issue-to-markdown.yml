name: Convert GitHub Issue to Markdown File

on:
  issues:
    types: [opened]

permissions:
  contents: write

jobs:
  generate-content:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate markdown from issue
        shell: bash
        run: |
          echo "ðŸ§© Parsing issue content..."

          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          LABELS=$(echo "${{ toJson(github.event.issue.labels) }}" | tr '[:upper:]' '[:lower:]')

          if echo "$LABELS" | grep -q "testimonial"; then
            FOLDER="tests"
          else
            FOLDER="posts"
          fi

          SLUG=$(echo "$TITLE" | iconv -c -t ascii | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')
          DATE=$(date +%Y-%m-%d)
          FILENAME="${FOLDER}/${DATE}-${SLUG}.md"
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

          mkdir -p "$FOLDER"
          echo "Generating file at: $FILENAME"

          cat <<EOF > "$FILENAME"
---
title: "$TITLE"
author: "Admin"
tags: ""
date: "$DATE"
image: ""
---

$BODY
EOF

      - name: Commit and push new markdown
        uses: EndBug/add-and-commit@v9
        with:
          add: ${{ env.FILENAME }}
          message: "ðŸ“„ Added: ${{ github.event.issue.title }}"
          default_author: github_actions
