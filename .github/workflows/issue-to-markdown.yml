name: Convert GitHub Issue to Markdown

on:
  issues:
    types: [opened]

permissions:
  contents: write

jobs:
  generate-markdown:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3

      - name: Generate markdown from issue
        run: |
          echo "üß© Starting conversion..."

          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          LABELS=$(echo "${{ toJson(github.event.issue.labels) }}" | tr '[:upper:]' '[:lower:]')

          echo "üîç Issue title: $TITLE"
          echo "üè∑Ô∏è Labels: $LABELS"

          if echo "$LABELS" | grep -q "testimonial"; then
            FOLDER="tests"
          else
            FOLDER="posts"
          fi

          mkdir -p "$FOLDER"

          SLUG=$(echo "$TITLE" | iconv -c -t ascii | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')
          DATE=$(date +%Y-%m-%d)
          FILENAME="$FOLDER/${DATE}-${SLUG}.md"

          echo "üìÑ Will create file: $FILENAME"

          {
            echo "---"
            echo "title: \"$TITLE\""
            echo "author: \"Admin\""
            echo "tags: \"\""
            echo "date: \"$DATE\""
            echo "image: \"\""
            echo "---"
            echo ""
            cat <<EOF
$BODY
EOF
          } > "$FILENAME"

      - name: Commit and push markdown
        uses: EndBug/add-and-commit@v9
        with:
          add: 'posts/ tests/'
          message: "üìÑ Auto-created post: ${{ github.event.issue.title }}"
          default_author: github_actions
